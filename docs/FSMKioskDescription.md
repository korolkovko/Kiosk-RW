# FSMKiosk: Состояния и переходы автомата исполнения заказа (KIOSK)

## Назначение

Данный автомат (FSMKiosk — конечный детерминированный автомат) управляет всем жизненным циклом заказа, начиная с момента нажатия пользователем кнопки "Оплатить" и до его завершения — успешного или аварийного.

FSMKiosk обеспечивает:

- Пошаговое управление через внешние компоненты: POS (оплата), ККТ (фискализация), принтер, кухня  
- Прозрачное логирование всех событий и ошибок  
- Возможность восстановления при сбоях  
- Завершение заказа всегда в одном из заранее определённых терминальных состояний  

## Основные таблицы модели данных

| Таблица             | Назначение                                                                 |
|---------------------|---------------------------------------------------------------------------|
| OrderFSMKioskRuntime     | Содержит текущее состояние FSMKiosk и агрегированный контекст                  |
| OrderLifecycleLog   | Неизменяемый журнал событий FSMKiosk (все попытки, ошибки, переходы)           |

## Как это связано с Order

Order имеет статусы ENUM: `PENDING`, `COMPLETED`, `FAILED`, `CANCELLED`

| Событие FSMKiosk                            | Новый OrderStatus   |
|----------------------------------------|----------------------|
| FSMKiosk запускается                        | `PENDING`            |
| FSMKiosk переходит в `COMPLETED`            | `COMPLETED`          |
| FSMKiosk завершился с ошибкой (любая)       | `FAILED`             |
| FSMKiosk завершён по таймауту / отменён     | `CANCELLED`          |

---

## Терминальные состояния и поведение системы

FSMKiosk всегда должен завершаться в одном из следующих терминальных состояний  
(кроме случаев аварийного завершения работы — отключение электропитания, сбой системы —  
в этих случаях FSMKiosk при старте находится в одном не из терминальных состояний и требует завершения —  
что будет реализовано автоматизированным (с администратором) аудитом для того чтобы привести все FSMKiosk в одно из терминальных состояний):

| TERMINAL STATE                                  | Что означает и что делает система                                                                                      |
|--------------------------------------------------|------------------------------------------------------------------------------------------------------------------------|
| `COMPLETED`                                      | Заказ полностью завершён и подтверждён извне                                                                           |
| `CANCELLED_BY_USER`                              | Пользователь отменил заказ до начала оплаты                                                                            |
| `CANCELLED_BY_TIMEOUT`                           | Пользователь не проявлял активность 30 секунд                                                                          |
| `CANCELLED_BY_ZERO_CULTURE`                      | Принудительная остановка по решению системы/администратора                                                             |
| `UNSUCCESSFUL_PAYMENT`                           | Ошибка или таймаут при оплате, попытки исчерпаны                                                                       |
| `UNSUCCESSFUL_FISCALIZATION`                     | Фискализация не удалась, ручной разбор                                                                                 |
| `UNSUCCESSFUL_PRINTING_ALTERNATIVE_RECEIPT_DECLINED` | Ошибка печати, код на экране не принят пользователем. Реализовано так, что если система не смогла напечатать чек,  
автомат предложит пользователю получить информацию в виде QR-кода или иным способом. Если пользователь соглашается — выполнение продолжается. Если нет — заказ отменяется. |
| `UNKNOWN_EXECUTION_NO_RESPONSE`                  | Нет подтверждения от кухни через 3 часа — авто-завершение                                                              |

---

## Стратегия восстановления (Recovery)

При первом запуске системы (например, после отключения электричества или перезапуска сервиса), необходимо:

1. Найти все записи в `OrderFSMKioskRuntime`, у которых `CurrentState` не является терминальным.  
2. Получить последнее событие из `OrderLifecycleLog` по каждому FSMKiosk.  
3. FSMKiosk, ожидающие внешние ответы (от pos-терминалов, ККТ, кухни и т.п.), должны быть:
   - Поставлены в очередь на административную проверку.  

Требуется реализовать отдельный пайплайн восстановления, который включает:

- сканирование устройств (POS, ККТ, принтер, кухня),  
- формирование задач для разбора оператором или администратором,  
- отчётность и мониторинг зависших FSMKiosk-процессов.  

FSMKiosk должен быть реализован так, чтобы всегда завершаться —  
либо автоматически, либо вручную через интерфейс управления после аварийных ситуаций.
